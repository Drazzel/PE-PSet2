---
title: "PE-PSet2"
output: pdf_document
author: Drazzel Feliu - 12174100
---

```{r setup, results='hide', warning=FALSE, message=FALSE,include=FALSE}
# Clear Workspace
rm(list=ls())

# Load Libraries
library(haven)
library(reshape)
library(tidyverse)
library(magrittr)
library(survival)
library(ggplot2)
```

For this assignment, provide a write-‐up where you answer the questions below,
selectively cutting and pasting output where needed. Be concise in your write-up; excess wordiness will be penalized. Also, submit a log file that includes commands and results for your entire analysis. The assignment makes use of almond_etal_2008.dta, which you can find on Canvas.

```{r}
# load data set
data <- read_dta("almond_etal_2008.dta")
# create data table identifying class and labels for each variable
datainfo <- data.frame(variable=colnames(data),
              class=sapply(data, class),
              label=sapply(data, function (x) attr(x, "label")))
datainfo <- `rownames<-`(datainfo, 1:44)
datainfo
# summary statistics of variables
summary(data)
```

# Motivation

A key policy question in health economics is whether the benefits of additional medical expenditures exceed their cost. The question is particularly relevant since medical expenditures in the United States have been on the rise for a long time. To analyze this question Almond et al (2008), use a RDD design and compare health outcomes of newborns around the threshold of very low birth weight (1500 grams).They argue that the threshold is commonly used as a rule of thumb to prescribe medical treatment, which is followed mainly by convention, and does not reflect biological criteria. In this problem set we will reproduce some of their basic results,so start by reading their paper, which you can find in Canvas.

# Questions:

## 1

Start by getting the descriptive statistics of birth weight in the sample, what is the mean, standard deviation, minimum, and maximum?

```{r}
mean(data$bweight)
sd(data$bweight)
min(data$bweight)
max(data$bweight)
```

## Answer

The mean birth weight is 1511.58 grams.
The standard deviation is 89.02.
The minimum birth weight is 1350 grams.
The maximum birth weight is 1650 grams.

## 2

Now plot one year and 28 day mortality rates against our running variable, birth weight. To do so, make bins of one ounce (28.35 grams) around the 1500 grams threshold, and get the mean mortality rate on each bin. Make a separate graph for each outcome. Describe the relationship between birth weight and mortality. Does it appear to be a discontinuity of mortality around the very low birth weight threshold? How does the number of observations in each bin affect your mean estimates?

## Answer

```{r, echo=FALSE, results='hide', warning=FALSE, message=FALSE,include=FALSE}
upbins <- seq(from= 1500, to=max(data$bweight), by= 28.35)
lobins <- seq(from= 1500, to=min(data$bweight), by = -28.35)

ggplot(data, aes(x=bweight, col = "blue")) + geom_histogram(binwidth = 28.35) + scale_x_continuous(breaks = c(lobins, upbins)) + xlab("Birth Weight") + ylab("Count") + theme_classic() + geom_vline(xintercept = 1500, col="pink")
```

```{r, echo=FALSE, results='hide'}
#create data bins
data$bins <- cut(data$bweight, breaks = c(min(data$bweight)-1,rev(lobins[2:6]), upbins, max(data$bweight)+1), labels = 1:12)

#label bins
data$bins = factor(data$bins,labels=c("1350-1358","1359-1386","1387-1414","1415-1443","1444-1471","1472-1500","1501-1528","1529-1556","1557-1585","1586-1613","1614-1641","1642-1650"))

#produce plots
plot1 <- data %>% group_by(bins) %>% summarize(mean = mean(agedth5)) %>% ggplot(aes(bins,mean)) + geom_point() + geom_vline(xintercept = 6.5, col = "pink") + theme_classic() + ylab("Mean 1 Year Mortality Rate") + xlab("Birth Weight Bins") + ylim(0.025, 0.09)

plot2 <- data %>% group_by(bins) %>% summarize(mean = mean(agedth4)) %>% ggplot(aes(bins,mean)) + geom_point() + geom_vline(xintercept = 6.5, col = "pink") + theme_classic() + ylab("Mean 28 Day Mortality Rate") + xlab("Birth Weight Bins") + ylim(0.025, 0.09)
```

Mean 1 Year Mortality Rate by Birth Weight
```{r}
plot1
```
Mean 28 Day Mortality Rate by Birth Weight
```{r}
plot2
```

The relationship between birth weight and both of the mortality measures we analyzed in our plots are negatively correlated and highly statistically significant, indicating that higher birth weights are correlated with a minimized probability of mortality, both 28 days out and 1 year out from date of birth.
```{r}
cor.test(data$agedth4,data$bweight)
cor.test(data$agedth5,data$bweight)
```

The regression discontinuity at 1500 grams seems to be fuzzy. It does not indicate a marked increase in the probability of a premature death at either of the date cutoffs specified previously (28 days or 1 year).

The mean estimate for the lowest bin (1350-1358) is sensitive because the number of observations is ~10% the size of the other bins. Any outliers in either direction are likely to bias the mean estimate of that bin.
```{r}
data %>% count(bins)
```

## 3

A key assumption for an RDD to provide a causal estimate is that individuals are not able to sort according to the running variable, i.e., they should not be able to manipulate its value. Discuss in your own words whether this is a reasonable assumption in this case. (Include tables with the relevant info (Coefficients of interest, standard errors and sample size).)

## Answer

This assumption is reasonable. While there may be some financial incentive to induce early births on behalf of the practicing obstetrician (in order to charge more in future services), there seems likely to be enough practical resistance to inducing early births around the cutoff. Especially when considering that attempting to fall below the cutoff only endangers the life of the baby even more. No parent, under this scenario, would attempt to induce an early birth. The cutoff of 1500 grams is also so low that no parent would reasonably attempt to have a baby born at so low a weight (3.3 lbs).

## 4

Assess informally whether the behavior of other covariates is smooth around the threshold, by plotting the mean of some covariates (mother’s age, mother’s education less than high school, gestational age, prenatal care visits, and year of birth) against birth weight as you did in point (2). Is there any evidence of discontinuities on other covariates around the very low birth weight threshold? If they were, how could these affect your RDD estimates?

## Answer

```{r}
plot3 <- data %>% group_by(bins) %>% summarize(mean = mean(mom_age)) %>% ggplot(aes(bins,mean)) + geom_point() + geom_vline(xintercept = 6.5, col = "pink") + theme_classic() + ylab("Mean Mother's Age") + xlab("Birth Weight Bins")
plot3

plot4 <- data %>% group_by(bins) %>% summarize(mean = mean(mom_ed1)) %>% ggplot(aes(bins,mean)) + geom_point() + geom_vline(xintercept = 6.5, col = "pink") + theme_classic() + ylab("Mean Mother's Education (Below High School)") + xlab("Birth Weight Bins")
plot4

plot5 <- data %>% group_by(bins) %>% summarize(mean = mean(nprenatal, na.rm = TRUE)) %>% ggplot(aes(bins,mean)) + geom_point() + geom_vline(xintercept = 6.5, col = "pink") + theme_classic() + ylab("Mean Prenatal Visits") + xlab("Birth Weight Bins")
plot5

plot6 <- data %>% group_by(bins) %>% summarize(mean = mean(gest, na.rm = TRUE)) %>% ggplot(aes(bins,mean)) + geom_point() + geom_vline(xintercept = 6.5, col = "pink") + theme_classic() + ylab("Mean Gestational Age") + xlab("Birth Weight Bins")
plot6
```
There is evidence of discontinuities on other covariates (particularly number of prenatal visits). The problem this could likely introduce in our RDD estimates is that the supposition that our populations are similar around the threshold will not hold and thereby undermining the assumption necessary for us to estimate the RDD accurately.

## 5

Now get an estimate of the size of the discontinuity in one-‐year and 28-‐day mortality, around the 1500 grams threshold using a caliper of 85 grams (above and below the threshold). To do so, use the following model:

$$ Y_i = \alpha_0 + \alpha_1VLBW_i + \alpha_2VLBW_i*(g_i-1500) + \alpha_3*(1-VLBW_i)*(g_i - 1500) + \epsilon_i $$

where $Y_i$ is the outcome of interest, $VLBW_i$ indicates that a newborn had very low birth weight (<1500 grams), $g_i$ is birth weight, and $\epsilon_i$ a disturbance term. Interpret the coefficients $\alpha_1$, $\alpha_2$, and $\alpha_3$.

## Answer

## 6

Now add covariates to the model in (5). Include mother’s age, indicators for mother’s education and race, indicators for year of birth, indicators for gestational age and prenatal care visits. Use the dummies provided in the data for gestational age and prenatal care visits. Compare your estimates to those obtained in (5) and explain the difference if any.

## Answer

## 7

Use the model in (6) to assess the sensitivity of the estimates to the use of different calipers. Use calipers of 30 and 120 grams (above and below the 1500 threshold). Are the estimates any different to those obtained in (6)? What is the tradeoff that we face when increasing/decreasing the caliper?

## Answer

## 8

Synthetize your findings and discuss what kind of supplementary information would you need to make a cost-benefit analysis of treatment received by newborns close to the very low birth weight threshold.

## Answer
